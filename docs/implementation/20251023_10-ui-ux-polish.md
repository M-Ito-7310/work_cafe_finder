# Phase 10: UI/UXポリッシュ

**Phase**: 10/11
**見積もり時間**: 90-120分
**優先度**: Medium
**依存関係**: Phase 1-9（全Phase）

---

## 📋 Phase概要

ローディング状態の改善、エラーメッセージの追加、レスポンシブデザインの最適化、アクセシビリティ対応、アニメーションの追加を行い、アプリケーションのUXを向上させます。

## ✅ 目標

- ✅ ローディングスケルトンの実装
- ✅ エラーバウンダリの実装
- ✅ レスポンシブデザインの最適化
- ✅ アニメーション追加
- ✅ アクセシビリティ改善

---

## 📝 実装タスク

### 1. ローディングスケルトン

**src/components/ui/Skeleton.tsx:**
```typescript
export function Skeleton({ className = '' }: { className?: string }) {
  return (
    <div
      className={`animate-pulse rounded-lg bg-gray-200 ${className}`}
    />
  );
}

export function CafeCardSkeleton() {
  return (
    <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-2">
          <Skeleton className="h-8 w-8 rounded-full" />
          <div>
            <Skeleton className="h-4 w-24" />
            <Skeleton className="mt-1 h-3 w-16" />
          </div>
        </div>
        <Skeleton className="h-2 w-2 rounded-full" />
      </div>
      <div className="mt-4 grid grid-cols-2 gap-3">
        <Skeleton className="h-16 rounded-lg" />
        <Skeleton className="h-16 rounded-lg" />
        <Skeleton className="h-16 rounded-lg" />
        <Skeleton className="h-16 rounded-lg" />
      </div>
    </div>
  );
}
```

**src/components/cafe/CafeDetailModal.tsx を更新:**
```typescript
import { CafeCardSkeleton } from '@/components/ui/Skeleton';

// Loading状態を改善
{loading ? (
  <div className="space-y-4">
    <CafeCardSkeleton />
    <CafeCardSkeleton />
    <CafeCardSkeleton />
  </div>
) : (
  // ... existing content
)}
```

### 2. エラーバウンダリ

**src/components/error/ErrorBoundary.tsx:**
```typescript
'use client';

import { Component, ReactNode } from 'react';
import { AlertTriangle } from 'lucide-react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: any) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        this.props.fallback || (
          <div className="flex min-h-screen items-center justify-center bg-gray-50 p-4">
            <div className="w-full max-w-md rounded-lg bg-white p-8 text-center shadow-lg">
              <AlertTriangle className="mx-auto h-16 w-16 text-red-500" />
              <h2 className="mt-4 text-xl font-bold text-gray-900">
                エラーが発生しました
              </h2>
              <p className="mt-2 text-sm text-gray-600">
                {this.state.error?.message || '予期しないエラーが発生しました'}
              </p>
              <button
                onClick={() => window.location.reload()}
                className="mt-6 rounded-lg bg-primary-600 px-6 py-3 text-white hover:bg-primary-700"
              >
                ページを再読み込み
              </button>
            </div>
          </div>
        )
      );
    }

    return this.props.children;
  }
}
```

**src/app/layout.tsx を更新:**
```typescript
import { ErrorBoundary } from '@/components/error/ErrorBoundary';
import { SessionProvider } from '@/components/providers/SessionProvider';
import './globals.css';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        <ErrorBoundary>
          <SessionProvider>{children}</SessionProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### 3. エラー表示コンポーネント

**src/components/ui/ErrorMessage.tsx:**
```typescript
import { AlertCircle } from 'lucide-react';

interface ErrorMessageProps {
  title?: string;
  message: string;
  onRetry?: () => void;
}

export function ErrorMessage({ title, message, onRetry }: ErrorMessageProps) {
  return (
    <div className="rounded-lg border border-red-200 bg-red-50 p-4">
      <div className="flex items-start gap-3">
        <AlertCircle className="h-5 w-5 flex-shrink-0 text-red-500" />
        <div className="flex-1">
          {title && (
            <h3 className="font-semibold text-red-900">{title}</h3>
          )}
          <p className="mt-1 text-sm text-red-700">{message}</p>
          {onRetry && (
            <button
              onClick={onRetry}
              className="mt-2 text-sm font-medium text-red-600 hover:text-red-700"
            >
              再試行
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

### 4. レスポンシブデザイン最適化

**src/components/cafe/CafeDetailModal.tsx を更新:**
```typescript
<div className="fixed inset-0 z-[2000] flex items-end justify-center md:items-center">
  {/* Backdrop */}
  <div className="absolute inset-0 bg-black/50" onClick={onClose} />

  {/* Modal - モバイルは下から、デスクトップは中央 */}
  <div className="relative w-full md:max-w-2xl max-h-[90vh] overflow-hidden rounded-t-2xl md:rounded-2xl bg-white shadow-xl animate-slide-up md:animate-fade-in">
    {/* ... */}
  </div>
</div>
```

**tailwind.config.ts にアニメーション追加:**
```typescript
import type { Config } from 'tailwindcss';

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          200: '#bae6fd',
          300: '#7dd3fc',
          400: '#38bdf8',
          500: '#0ea5e9',
          600: '#0284c7',
          700: '#0369a1',
          800: '#075985',
          900: '#0c4a6e',
        },
      },
      animation: {
        'fade-in': 'fadeIn 0.2s ease-in-out',
        'slide-up': 'slideUp 0.3s ease-out',
        'spin-slow': 'spin 2s linear infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { transform: 'translateY(100%)' },
          '100%': { transform: 'translateY(0)' },
        },
      },
    },
  },
  plugins: [],
};

export default config;
```

### 5. アクセシビリティ改善

**src/components/map/MapFilters.tsx を更新:**
```typescript
<button
  onClick={() => setIsOpen(!isOpen)}
  className="flex items-center gap-2 rounded-lg bg-white px-4 py-3 shadow-lg transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
  aria-label="フィルターを開く"
  aria-expanded={isOpen}
>
  <Filter size={20} className="text-gray-700" />
  <span className="font-medium text-gray-900">フィルター</span>
  {activeFilterCount > 0 && (
    <span
      className="flex h-6 w-6 items-center justify-center rounded-full bg-primary-600 text-xs font-bold text-white"
      aria-label={`${activeFilterCount}個のフィルターが有効`}
    >
      {activeFilterCount}
    </span>
  )}
</button>
```

**src/components/cafe/CafeDetailModal.tsx を更新:**
```typescript
<button
  onClick={onClose}
  className="rounded-lg p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500"
  aria-label="モーダルを閉じる"
>
  <X size={24} />
</button>
```

### 6. メタデータとSEO

**src/app/layout.tsx を更新:**
```typescript
import type { Metadata } from 'next';
import { ErrorBoundary } from '@/components/error/ErrorBoundary';
import { SessionProvider } from '@/components/providers/SessionProvider';
import './globals.css';

export const metadata: Metadata = {
  title: 'WorkCafeFinder - 作業できるカフェを見つけよう',
  description: 'リアルタイムで作業しやすいカフェを見つけられる地図アプリ。空席状況、Wi-Fi、電源の有無をユーザーが共有。',
  keywords: ['カフェ', '作業', 'ノマド', 'Wi-Fi', '電源', '地図'],
  openGraph: {
    title: 'WorkCafeFinder',
    description: 'リアルタイムで作業しやすいカフェを見つけよう',
    type: 'website',
  },
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 1,
  },
  themeColor: '#0284c7',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <head>
        <link rel="icon" href="/favicon.ico" />
      </head>
      <body className="antialiased">
        <ErrorBoundary>
          <SessionProvider>{children}</SessionProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### 7. PWA対応（オプション）

**public/manifest.json:**
```json
{
  "name": "WorkCafeFinder",
  "short_name": "WCF",
  "description": "作業できるカフェを見つけよう",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0284c7",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

**src/app/layout.tsx にmanifest追加:**
```typescript
export const metadata: Metadata = {
  // ... existing metadata
  manifest: '/manifest.json',
};
```

### 8. ローディングページ

**src/app/loading.tsx:**
```typescript
export default function Loading() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <div className="text-center">
        <div className="mx-auto h-12 w-12 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"></div>
        <p className="mt-4 text-sm text-gray-600">読み込み中...</p>
      </div>
    </div>
  );
}
```

### 9. 404ページ

**src/app/not-found.tsx:**
```typescript
import Link from 'next/link';

export default function NotFound() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
      <div className="text-center">
        <h1 className="text-6xl font-bold text-gray-900">404</h1>
        <p className="mt-4 text-xl text-gray-600">
          ページが見つかりません
        </p>
        <Link
          href="/"
          className="mt-8 inline-block rounded-lg bg-primary-600 px-6 py-3 font-semibold text-white hover:bg-primary-700"
        >
          ホームに戻る
        </Link>
      </div>
    </div>
  );
}
```

### 10. パフォーマンス最適化

**next.config.js を更新:**
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['lh3.googleusercontent.com', 'pbs.twimg.com'],
    formats: ['image/avif', 'image/webp'],
  },
  compress: true,
  poweredByHeader: false,
  reactStrictMode: true,
};

module.exports = nextConfig;
```

---

## 📦 成果物

### 完了チェックリスト

- [ ] src/components/ui/Skeleton.tsx が作成されている
- [ ] src/components/error/ErrorBoundary.tsx が作成されている
- [ ] src/components/ui/ErrorMessage.tsx が作成されている
- [ ] tailwind.config.ts にアニメーションが追加されている
- [ ] src/app/layout.tsx にメタデータが追加されている
- [ ] src/app/loading.tsx が作成されている
- [ ] src/app/not-found.tsx が作成されている
- [ ] レスポンシブデザインが最適化されている
- [ ] アクセシビリティが改善されている

### 動作確認

#### 1. ローディング状態
```
1. カフェ詳細モーダルを開く
2. スケルトンローディングが表示される
3. データ取得後にスムーズに切り替わる
```

#### 2. エラーハンドリング
```
1. ネットワークをオフにする
2. カフェ取得を試みる
3. エラーメッセージが表示される
```

#### 3. レスポンシブ
```
1. モバイル表示で確認
2. モーダルが下からスライドアップ
3. タブレット/デスクトップで中央表示
```

#### 4. アニメーション
```
1. モーダル開閉時にスムーズなアニメーション
2. フィルターパネル表示時にフェードイン
```

#### 5. アクセシビリティ
```
1. キーボードでフォーカス移動
2. aria-labelが適切に設定されている
3. スクリーンリーダーで読み上げ確認
```

---

## 🧪 テスト項目

| テスト項目 | 確認方法 | 期待結果 |
|-----------|---------|---------|
| スケルトン表示 | ローディング中 | スケルトン表示 |
| エラーバウンダリ | エラー発生時 | エラー画面表示 |
| モバイルレスポンシブ | 375px幅 | モーダル下からスライド |
| デスクトップ表示 | 1920px幅 | モーダル中央表示 |
| フォーカス管理 | Tabキー | 適切にフォーカス移動 |
| 404ページ | 存在しないURL | 404ページ表示 |
| SEO | View Page Source | メタタグ確認 |
| PWA | Lighthouse | PWA対応確認 |

---

## ⚠️ トラブルシューティング

### 問題1: アニメーションが動作しない

**原因**: Tailwind設定が反映されていない

**解決策**:
```bash
# Tailwind CSSを再ビルド
npm run dev
```

### 問題2: モバイルでスクロールできない

**原因**: overflow設定の問題

**解決策**:
```typescript
// モーダルのoverflow-y-autoを確認
className="overflow-y-auto"
```

### 問題3: 画像が読み込まれない

**原因**: next.config.jsのdomains設定不足

**解決策**:
```javascript
// next.config.jsにドメインを追加
images: {
  domains: ['lh3.googleusercontent.com', 'pbs.twimg.com'],
}
```

---

## 📚 参考資料

- [Next.js Metadata](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)
- [React Error Boundaries](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)
- [Tailwind CSS Animations](https://tailwindcss.com/docs/animation)
- [Web Accessibility](https://www.w3.org/WAI/WCAG21/quickref/)
- [PWA Manifest](https://web.dev/add-manifest/)

---

## 🎯 次のPhase

Phase 10が完了したら、**Phase 11: Vercelデプロイ** (`20251023_11-deployment.md`) に進みます。

---

**Phase完了日**: ___________
**実績時間**: ___________
**担当者**: ___________
**レビュー**: ___________
