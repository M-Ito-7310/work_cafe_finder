# Phase 11: Vercelデプロイ

**Phase**: 11/11
**見積もり時間**: 60-90分
**優先度**: High
**依存関係**: Phase 1-10（全Phase）

---

## 📋 Phase概要

VercelへのNext.jsアプリケーションのデプロイ、環境変数の設定、OAuth認証のリダイレクトURI設定、本番環境の動作確認を行います。

## ✅ 目標

- ✅ Vercelプロジェクトのセットアップ
- ✅ 環境変数の設定
- ✅ OAuth認証の本番用設定
- ✅ デプロイの実行
- ✅ 本番環境の動作確認

---

## 📝 実装タスク

### 1. Vercelアカウントとプロジェクトセットアップ

#### 1-1. Vercelアカウント作成
```
1. https://vercel.com/ にアクセス
2. GitHubアカウントでサインアップ
3. アカウント作成完了
```

#### 1-2. GitHubリポジトリの準備
```bash
# ローカルで作業
cd work-cafe-finder

# .gitignoreの確認
cat .gitignore

# 必ず以下が含まれていることを確認
# .env.local
# .env*.local
# .vercel

# GitHubリポジトリ作成
# https://github.com/new でリポジトリ作成

# リモートリポジトリ設定
git remote add origin https://github.com/YOUR_USERNAME/work-cafe-finder.git
git branch -M main
git add .
git commit -m "Initial commit"
git push -u origin main
```

### 2. Vercelプロジェクト作成

```
1. Vercel Dashboard (https://vercel.com/dashboard) にアクセス
2. 「Add New...」→ 「Project」をクリック
3. GitHubリポジトリをインポート
4. 「work-cafe-finder」を選択
5. フレームワーク: Next.js（自動検出）
6. Root Directory: ./（デフォルト）
7. 「Deploy」はまだクリックしない（環境変数を先に設定）
```

### 3. 環境変数の設定

#### 3-1. Vercel環境変数設定
```
1. Vercel Project Settings → Environment Variables
2. 以下の環境変数を追加（.env.localから）:
```

**本番環境の環境変数:**
```env
# Database
DATABASE_URL=your-neon-database-url

# NextAuth
NEXTAUTH_URL=https://your-app.vercel.app
NEXTAUTH_SECRET=your-production-secret  # 新しく生成する

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# X (Twitter) OAuth
TWITTER_CLIENT_ID=your-twitter-client-id
TWITTER_CLIENT_SECRET=your-twitter-client-secret
```

#### 3-2. 本番用NEXTAUTH_SECRETの生成
```bash
# ローカルで生成
openssl rand -base64 32

# 出力された文字列をVercelの環境変数に設定
```

### 4. OAuth認証の本番用設定

#### 4-1. Google OAuth本番用設定

```
1. Google Cloud Console (https://console.cloud.google.com/) にアクセス
2. プロジェクトを選択
3. APIとサービス → 認証情報
4. OAuth 2.0 クライアントIDを選択
5. 承認済みのリダイレクトURIに追加:
   - https://your-app.vercel.app/api/auth/callback/google
6. 保存
```

#### 4-2. X (Twitter) OAuth本番用設定

```
1. X Developer Portal (https://developer.twitter.com/) にアクセス
2. アプリケーションを選択
3. App Settings → User authentication settings
4. Callback URL / Redirect URLに追加:
   - https://your-app.vercel.app/api/auth/callback/twitter
5. Save
```

### 5. デプロイ前の最終確認

**package.json の確認:**
```json
{
  "name": "work-cafe-finder",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    // ... すべての依存関係が正しく記載されている
  }
}
```

**next.config.js の確認:**
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['lh3.googleusercontent.com', 'pbs.twimg.com'],
    formats: ['image/avif', 'image/webp'],
  },
  compress: true,
  poweredByHeader: false,
  reactStrictMode: true,
};

module.exports = nextConfig;
```

**ローカルビルドテスト:**
```bash
# ビルドが成功することを確認
npm run build

# 型チェック
npm run type-check

# Lint
npm run lint
```

### 6. デプロイ実行

#### 6-1. 初回デプロイ
```
1. Vercel Dashboard でプロジェクトを開く
2. 「Deploy」ボタンをクリック
3. デプロイ開始（5-10分）
4. デプロイ完了を待つ
5. デプロイURLを確認: https://work-cafe-finder.vercel.app
```

#### 6-2. デプロイログの確認
```
1. Vercel Dashboard → Deployments
2. 最新のデプロイをクリック
3. ビルドログを確認
4. エラーがないことを確認
```

### 7. カスタムドメイン設定（オプション）

```
1. Vercel Project Settings → Domains
2. 「Add」ボタンをクリック
3. 独自ドメインを入力（例: workcafefinder.com）
4. DNS設定を指示に従って設定
5. NEXTAUTH_URLを更新
6. OAuth認証のリダイレクトURIも更新
```

### 8. 本番環境の動作確認

#### 8-1. 基本動作確認
```
1. https://your-app.vercel.app にアクセス
2. トップページが表示される
3. /map ページが正しく表示される
4. 地図が読み込まれる
```

#### 8-2. 認証機能確認
```
1. 「ログイン」ボタンをクリック
2. Googleログインを試す
3. 認証後、/map にリダイレクトされる
4. Headerにユーザー名と画像が表示される
5. ログアウトできる
```

#### 8-3. カフェ表示確認
```
1. 地図を移動
2. カフェマーカーが表示される
3. マーカーをクリック
4. カフェ詳細モーダルが開く
```

#### 8-4. 投稿機能確認
```
1. ログイン状態で「投稿する」タブをクリック
2. フォームに入力
3. 投稿送信
4. 投稿が成功する
5. 投稿一覧に表示される
```

#### 8-5. フィルター確認
```
1. フィルターボタンをクリック
2. フィルターを選択
3. カフェが絞り込まれる
```

### 9. パフォーマンス確認

**Lighthouse監査:**
```
1. Chrome DevToolsを開く
2. Lighthouseタブを選択
3. カテゴリ: すべて選択
4. 「Analyze page load」をクリック
5. スコアを確認:
   - Performance: 90+
   - Accessibility: 90+
   - Best Practices: 90+
   - SEO: 90+
```

### 10. モニタリングとログ

**Vercel Analytics（オプション）:**
```
1. Vercel Project Settings → Analytics
2. 「Enable Analytics」をクリック
3. ページビュー、パフォーマンスを確認
```

**Vercel Logs:**
```
1. Vercel Dashboard → Logs
2. リアルタイムログを確認
3. エラーログを監視
```

### 11. 継続的デプロイ（CI/CD）

**自動デプロイ設定:**
```
1. GitHubにpush
git add .
git commit -m "Update feature"
git push origin main

2. Vercel が自動的にデプロイ
3. プレビューURLが生成される
4. main ブランチのpushは本番にデプロイ
```

**ブランチプレビュー:**
```
1. feature ブランチを作成
git checkout -b feature/new-feature

2. 変更をpush
git push origin feature/new-feature

3. Vercelが自動的にプレビュー環境を生成
4. プレビューURLで動作確認
5. PRマージ後、本番に自動デプロイ
```

---

## 📦 成果物

### 完了チェックリスト

- [ ] Vercelプロジェクトが作成されている
- [ ] 環境変数がすべて設定されている
- [ ] OAuth認証の本番用リダイレクトURIが設定されている
- [ ] 初回デプロイが成功している
- [ ] トップページが表示される
- [ ] 認証機能が動作する
- [ ] カフェ表示機能が動作する
- [ ] 投稿機能が動作する
- [ ] フィルター機能が動作する
- [ ] Lighthouseスコアが90+

### 本番URL

- **本番URL**: https://your-app.vercel.app
- **カスタムドメイン**: https://workcafefinder.com（設定済みの場合）

---

## 🧪 テスト項目

| テスト項目 | 確認方法 | 期待結果 |
|-----------|---------|---------|
| トップページ表示 | / にアクセス | 200 OK |
| 地図ページ表示 | /map にアクセス | 地図表示 |
| Googleログイン | 認証フロー | ログイン成功 |
| Xログイン | 認証フロー | ログイン成功 |
| カフェマーカー表示 | 地図移動 | マーカー表示 |
| カフェ詳細表示 | マーカークリック | モーダル表示 |
| 投稿機能 | フォーム送信 | 投稿成功 |
| フィルター機能 | フィルター選択 | 絞り込み成功 |
| レスポンシブ | モバイル表示 | 適切に表示 |
| HTTPS | URL確認 | HTTPSで表示 |

---

## ⚠️ トラブルシューティング

### 問題1: デプロイが失敗する

**原因**: ビルドエラー

**解決策**:
```bash
# ローカルでビルドテスト
npm run build

# エラーを修正してから再デプロイ
git add .
git commit -m "Fix build errors"
git push origin main
```

### 問題2: 認証が失敗する

**原因**: OAuth認証のリダイレクトURIが正しくない

**解決策**:
```
1. Google Cloud Console / X Developer Portalで確認
2. リダイレクトURIが本番URLになっているか確認
3. NEXTAUTH_URLが正しく設定されているか確認
```

### 問題3: データベース接続エラー

**原因**: DATABASE_URLが正しくない

**解決策**:
```
1. Neon Dashboardで接続文字列を確認
2. Vercel環境変数を再設定
3. 再デプロイ
```

### 問題4: 環境変数が反映されない

**原因**: デプロイ後に環境変数を変更した

**解決策**:
```
1. Vercel Dashboard → Deployments
2. 最新デプロイの「... More」→「Redeploy」
3. 環境変数が反映される
```

### 問題5: 画像が読み込まれない

**原因**: next.config.jsのdomains設定不足

**解決策**:
```javascript
// next.config.jsを確認
images: {
  domains: ['lh3.googleusercontent.com', 'pbs.twimg.com'],
}

// 変更後、再デプロイ
```

---

## 📚 参考資料

- [Vercel 公式ドキュメント](https://vercel.com/docs)
- [Next.js デプロイ](https://nextjs.org/docs/deployment)
- [Vercel 環境変数](https://vercel.com/docs/concepts/projects/environment-variables)
- [Google OAuth 設定](https://console.cloud.google.com/)
- [X Developer Portal](https://developer.twitter.com/)

---

## 🎯 次のステップ

Phase 11が完了したら、以下のタスクに進むことができます:

1. **ユーザーフィードバック収集**
   - Google Analyticsの導入
   - ユーザーフィードバックフォームの追加

2. **機能追加**
   - お気に入りカフェ機能
   - カフェ評価機能
   - 通知機能

3. **パフォーマンス最適化**
   - 画像最適化
   - キャッシュ戦略の改善
   - API レスポンス最適化

4. **マーケティング**
   - SNSシェア機能
   - OGP画像の最適化
   - SEO強化

---

## 🎉 プロジェクト完了

おめでとうございます！WorkCafeFinderプロジェクトのすべてのPhaseが完了しました。

### 完成した機能

✅ Next.js 14 + TypeScript + Tailwind CSS
✅ Leaflet + OpenStreetMap 地図統合
✅ NextAuth.js認証（Google, X）
✅ Drizzle ORM + Neon PostgreSQL
✅ カフェマーカー表示（鮮度別色分け）
✅ カフェ詳細モーダル
✅ 投稿システム（空席、静かさ、Wi-Fi、電源）
✅ フィルタリング機能
✅ レスポンシブデザイン
✅ アクセシビリティ対応
✅ Vercelデプロイ

### 技術スタック

- **Frontend**: Next.js 14, React, TypeScript, Tailwind CSS
- **地図**: Leaflet, react-leaflet, OpenStreetMap
- **認証**: NextAuth.js (Google OAuth, X OAuth)
- **データベース**: Neon PostgreSQL, Drizzle ORM
- **バリデーション**: Zod
- **デプロイ**: Vercel

---

**Phase完了日**: ___________
**実績時間**: ___________
**担当者**: ___________
**レビュー**: ___________
