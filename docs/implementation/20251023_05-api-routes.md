# Phase 5: API Routeså®Ÿè£…

**Phase**: 5/11
**è¦‹ç©ã‚‚ã‚Šæ™‚é–“**: 60-90åˆ†
**å„ªå…ˆåº¦**: High
**ä¾å­˜é–¢ä¿‚**: Phase 2, Phase 3, Phase 4

---

## ğŸ“‹ Phaseæ¦‚è¦

ã‚«ãƒ•ã‚§æƒ…å ±ã¨æŠ•ç¨¿ã®CRUD APIã‚’å®Ÿè£…ã—ã¾ã™ã€‚åœ°å›³ç¯„å›²å†…ã®ã‚«ãƒ•ã‚§å–å¾—ã€ã‚«ãƒ•ã‚§è©³ç´°å–å¾—ã€æŠ•ç¨¿ä½œæˆãƒ»å–å¾—ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

## âœ… ç›®æ¨™

- âœ… GET /api/cafes - ã‚«ãƒ•ã‚§ä¸€è¦§å–å¾—
- âœ… GET /api/cafes/[id] - ã‚«ãƒ•ã‚§è©³ç´°å–å¾—
- âœ… POST /api/reports - æŠ•ç¨¿ä½œæˆ
- âœ… GET /api/reports - æŠ•ç¨¿ä¸€è¦§å–å¾—
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

---

## ğŸ“ å®Ÿè£…ã‚¿ã‚¹ã‚¯

### 1. Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ

**src/lib/validations/report.ts:**
```typescript
import { z } from 'zod';

export const createReportSchema = z.object({
  cafeId: z.string().uuid('æœ‰åŠ¹ãªã‚«ãƒ•ã‚§IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„'),
  seatStatus: z.enum(['available', 'crowded', 'full'], {
    errorMap: () => ({ message: 'ç©ºå¸­çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„' }),
  }),
  quietness: z.enum(['quiet', 'normal', 'noisy'], {
    errorMap: () => ({ message: 'é™ã‹ã•ã‚’é¸æŠã—ã¦ãã ã•ã„' }),
  }),
  wifi: z.enum(['fast', 'normal', 'slow', 'none'], {
    errorMap: () => ({ message: 'Wi-Fié€Ÿåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„' }),
  }),
  powerOutlets: z.boolean({
    errorMap: () => ({ message: 'é›»æºå¸­ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„' }),
  }),
  comment: z.string().max(50, 'ã‚³ãƒ¡ãƒ³ãƒˆã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„').optional(),
});

export type CreateReportInput = z.infer<typeof createReportSchema>;
```

### 2. GET /api/cafes - ã‚«ãƒ•ã‚§ä¸€è¦§å–å¾—

**src/app/api/cafes/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCafesInBounds } from '@/lib/db/queries';
import type { CafesQueryParams } from '@/types';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—
    const neLat = parseFloat(searchParams.get('neLat') || '0');
    const neLng = parseFloat(searchParams.get('neLng') || '0');
    const swLat = parseFloat(searchParams.get('swLat') || '0');
    const swLng = parseFloat(searchParams.get('swLng') || '0');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!neLat || !neLng || !swLat || !swLng) {
      return NextResponse.json(
        { error: 'åœ°å›³ç¯„å›²ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™' },
        { status: 400 }
      );
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å–å¾—
    const filtersParam = searchParams.get('filters');
    const filters = filtersParam
      ? {
          seats: filtersParam.includes('seats'),
          quiet: filtersParam.includes('quiet'),
          wifi: filtersParam.includes('wifi'),
          power: filtersParam.includes('power'),
        }
      : undefined;

    const params: CafesQueryParams = {
      neLat,
      neLng,
      swLat,
      swLng,
      filters,
    };

    // ã‚«ãƒ•ã‚§å–å¾—
    const cafes = await getCafesInBounds(params);

    return NextResponse.json({
      success: true,
      data: cafes,
    });
  } catch (error) {
    console.error('GET /api/cafes error:', error);
    return NextResponse.json(
      { error: 'ã‚«ãƒ•ã‚§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### 3. GET /api/cafes/[id] - ã‚«ãƒ•ã‚§è©³ç´°å–å¾—

**src/app/api/cafes/[id]/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCafeWithReports } from '@/lib/db/queries';

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const { id } = params;

    // UUIDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const uuidRegex =
      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(id)) {
      return NextResponse.json(
        { error: 'æœ‰åŠ¹ãªã‚«ãƒ•ã‚§IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„' },
        { status: 400 }
      );
    }

    // ã‚«ãƒ•ã‚§è©³ç´°å–å¾—
    const cafe = await getCafeWithReports(id);

    if (!cafe) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ•ã‚§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json({
      success: true,
      data: cafe,
    });
  } catch (error) {
    console.error('GET /api/cafes/[id] error:', error);
    return NextResponse.json(
      { error: 'ã‚«ãƒ•ã‚§è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### 4. POST /api/reports - æŠ•ç¨¿ä½œæˆ

**src/app/api/reports/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from '@/lib/auth/getServerSession';
import { createReport } from '@/lib/db/queries';
import { createReportSchema } from '@/lib/validations/report';

export async function POST(request: NextRequest) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await getServerSession();
    if (!session || !session.user?.id) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å–å¾—
    const body = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const validationResult = createReportSchema.safeParse(body);
    if (!validationResult.success) {
      return NextResponse.json(
        {
          error: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼',
          details: validationResult.error.errors,
        },
        { status: 400 }
      );
    }

    const data = validationResult.data;

    // æŠ•ç¨¿ä½œæˆ
    const report = await createReport({
      cafeId: data.cafeId,
      userId: session.user.id,
      seatStatus: data.seatStatus,
      quietness: data.quietness,
      wifi: data.wifi,
      powerOutlets: data.powerOutlets,
      comment: data.comment,
    });

    return NextResponse.json(
      {
        success: true,
        data: report,
        message: 'æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸ',
      },
      { status: 201 }
    );
  } catch (error) {
    console.error('POST /api/reports error:', error);
    return NextResponse.json(
      { error: 'æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const cafeId = searchParams.get('cafeId');

    if (!cafeId) {
      return NextResponse.json(
        { error: 'cafeIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™' },
        { status: 400 }
      );
    }

    // ã‚«ãƒ•ã‚§ã®æŠ•ç¨¿ä¸€è¦§å–å¾—
    const cafe = await getCafeWithReports(cafeId);

    if (!cafe) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ•ã‚§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json({
      success: true,
      data: cafe.reports || [],
    });
  } catch (error) {
    console.error('GET /api/reports error:', error);
    return NextResponse.json(
      { error: 'æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

**src/lib/api/errorHandler.ts:**
```typescript
import { NextResponse } from 'next/server';

export class ApiError extends Error {
  constructor(
    public statusCode: number,
    message: string
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

export function handleApiError(error: unknown) {
  console.error('API Error:', error);

  if (error instanceof ApiError) {
    return NextResponse.json(
      { error: error.message },
      { status: error.statusCode }
    );
  }

  return NextResponse.json(
    { error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
    { status: 500 }
  );
}
```

### 6. APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

**src/lib/api/client.ts:**
```typescript
import type { ApiResponse, CafesQueryParams } from '@/types';

export class ApiClient {
  private baseUrl = '/api';

  async getCafes(params: CafesQueryParams) {
    const query = new URLSearchParams({
      neLat: params.neLat.toString(),
      neLng: params.neLng.toString(),
      swLat: params.swLat.toString(),
      swLng: params.swLng.toString(),
    });

    if (params.filters) {
      const filters = Object.entries(params.filters)
        .filter(([_, value]) => value)
        .map(([key]) => key)
        .join(',');
      if (filters) query.append('filters', filters);
    }

    const response = await fetch(`${this.baseUrl}/cafes?${query}`);
    return this.handleResponse(response);
  }

  async getCafe(id: string) {
    const response = await fetch(`${this.baseUrl}/cafes/${id}`);
    return this.handleResponse(response);
  }

  async createReport(data: {
    cafeId: string;
    seatStatus: 'available' | 'crowded' | 'full';
    quietness: 'quiet' | 'normal' | 'noisy';
    wifi: 'fast' | 'normal' | 'slow' | 'none';
    powerOutlets: boolean;
    comment?: string;
  }) {
    const response = await fetch(`${this.baseUrl}/reports`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });
    return this.handleResponse(response);
  }

  private async handleResponse<T>(response: Response): Promise<ApiResponse<T>> {
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'APIã‚¨ãƒ©ãƒ¼');
    }

    return data;
  }
}

export const apiClient = new ApiClient();
```

---

## ğŸ“¦ æˆæœç‰©

### å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] src/lib/validations/report.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] src/app/api/cafes/route.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] src/app/api/cafes/[id]/route.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] src/app/api/reports/route.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] src/lib/api/errorHandler.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] src/lib/api/client.ts ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®APIãŒæ­£ã—ãå‹•ä½œã™ã‚‹

### å‹•ä½œç¢ºèª

#### 1. ã‚«ãƒ•ã‚§ä¸€è¦§å–å¾—
```bash
curl "http://localhost:3000/api/cafes?neLat=35.69&neLng=139.78&swLat=35.67&swLng=139.76"
```

#### 2. ã‚«ãƒ•ã‚§è©³ç´°å–å¾—
```bash
curl "http://localhost:3000/api/cafes/{cafe-id}"
```

#### 3. æŠ•ç¨¿ä½œæˆï¼ˆèªè¨¼å¿…é ˆï¼‰
```bash
curl -X POST "http://localhost:3000/api/reports" \
  -H "Content-Type: application/json" \
  -d '{
    "cafeId": "{cafe-id}",
    "seatStatus": "available",
    "quietness": "quiet",
    "wifi": "fast",
    "powerOutlets": true,
    "comment": "çª“å´ã®å¸­ãŒç©ºã„ã¦ã¾ã™"
  }'
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®

| ãƒ†ã‚¹ãƒˆé …ç›® | ç¢ºèªæ–¹æ³• | æœŸå¾…çµæœ |
|-----------|---------|---------|
| ã‚«ãƒ•ã‚§ä¸€è¦§å–å¾— | GET /api/cafes | 200, ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ |
| ã‚«ãƒ•ã‚§è©³ç´°å–å¾— | GET /api/cafes/[id] | 200, è©³ç´°å–å¾—æˆåŠŸ |
| æŠ•ç¨¿ä½œæˆï¼ˆèªè¨¼æ¸ˆï¼‰ | POST /api/reports | 201, æŠ•ç¨¿ä½œæˆæˆåŠŸ |
| æŠ•ç¨¿ä½œæˆï¼ˆæœªèªè¨¼ï¼‰ | POST /api/reports | 401ã‚¨ãƒ©ãƒ¼ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | POST /api/reports (ä¸æ­£ãƒ‡ãƒ¼ã‚¿) | 400ã‚¨ãƒ©ãƒ¼ |
| å­˜åœ¨ã—ãªã„ã‚«ãƒ•ã‚§ | GET /api/cafes/invalid-id | 404ã‚¨ãƒ©ãƒ¼ |

---

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: èªè¨¼ã‚¨ãƒ©ãƒ¼

**åŸå› **: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå–å¾—ã§ããªã„

**è§£æ±ºç­–**:
```typescript
// Phase 4ã®èªè¨¼è¨­å®šã‚’ç¢ºèª
// getServerSession()ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

### å•é¡Œ2: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

**åŸå› **: Zodã‚¹ã‚­ãƒ¼ãƒã¨ãƒ‡ãƒ¼ã‚¿ãŒä¸€è‡´ã—ãªã„

**è§£æ±ºç­–**:
```typescript
// createReportSchemaã‚’ç¢ºèª
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ã‚’ç¢ºèª
```

### å•é¡Œ3: CORSã‚¨ãƒ©ãƒ¼

**åŸå› **: æœ¬ç•ªç’°å¢ƒã§ã®CORSè¨­å®š

**è§£æ±ºç­–**:
```typescript
// next.config.jsã«CORSè¨­å®šã‚’è¿½åŠ ï¼ˆæœ¬ç•ªç’°å¢ƒã§å¿…è¦ãªå ´åˆï¼‰
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Zod](https://zod.dev/)
- [Drizzle ORM Queries](https://orm.drizzle.team/docs/rqb)

---

## ğŸ¯ æ¬¡ã®Phase

Phase 5ãŒå®Œäº†ã—ãŸã‚‰ã€**Phase 6: åœ°å›³çµ±åˆ** (`20251023_06-map-integration.md`) ã«é€²ã¿ã¾ã™ã€‚

---

**Phaseå®Œäº†æ—¥**: ___________
**å®Ÿç¸¾æ™‚é–“**: ___________
**æ‹…å½“è€…**: ___________
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ___________
