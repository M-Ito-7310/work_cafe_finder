# Phase 5: API Routes実装

**Phase**: 5/11
**見積もり時間**: 60-90分
**優先度**: High
**依存関係**: Phase 2, Phase 3, Phase 4

---

## 📋 Phase概要

カフェ情報と投稿のCRUD APIを実装します。地図範囲内のカフェ取得、カフェ詳細取得、投稿作成・取得のAPIエンドポイントを作成します。

## ✅ 目標

- ✅ GET /api/cafes - カフェ一覧取得
- ✅ GET /api/cafes/[id] - カフェ詳細取得
- ✅ POST /api/reports - 投稿作成
- ✅ GET /api/reports - 投稿一覧取得
- ✅ エラーハンドリングとバリデーション

---

## 📝 実装タスク

### 1. Zodバリデーションスキーマ

**src/lib/validations/report.ts:**
```typescript
import { z } from 'zod';

export const createReportSchema = z.object({
  cafeId: z.string().uuid('有効なカフェIDを指定してください'),
  seatStatus: z.enum(['available', 'crowded', 'full'], {
    errorMap: () => ({ message: '空席状況を選択してください' }),
  }),
  quietness: z.enum(['quiet', 'normal', 'noisy'], {
    errorMap: () => ({ message: '静かさを選択してください' }),
  }),
  wifi: z.enum(['fast', 'normal', 'slow', 'none'], {
    errorMap: () => ({ message: 'Wi-Fi速度を選択してください' }),
  }),
  powerOutlets: z.boolean({
    errorMap: () => ({ message: '電源席の有無を選択してください' }),
  }),
  comment: z.string().max(50, 'コメントは50文字以内で入力してください').optional(),
});

export type CreateReportInput = z.infer<typeof createReportSchema>;
```

### 2. GET /api/cafes - カフェ一覧取得

**src/app/api/cafes/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCafesInBounds } from '@/lib/db/queries';
import type { CafesQueryParams } from '@/types';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);

    // クエリパラメータの取得
    const neLat = parseFloat(searchParams.get('neLat') || '0');
    const neLng = parseFloat(searchParams.get('neLng') || '0');
    const swLat = parseFloat(searchParams.get('swLat') || '0');
    const swLng = parseFloat(searchParams.get('swLng') || '0');

    // バリデーション
    if (!neLat || !neLng || !swLat || !swLng) {
      return NextResponse.json(
        { error: '地図範囲のパラメータが不正です' },
        { status: 400 }
      );
    }

    // フィルターの取得
    const filtersParam = searchParams.get('filters');
    const filters = filtersParam
      ? {
          seats: filtersParam.includes('seats'),
          quiet: filtersParam.includes('quiet'),
          wifi: filtersParam.includes('wifi'),
          power: filtersParam.includes('power'),
        }
      : undefined;

    const params: CafesQueryParams = {
      neLat,
      neLng,
      swLat,
      swLng,
      filters,
    };

    // カフェ取得
    const cafes = await getCafesInBounds(params);

    return NextResponse.json({
      success: true,
      data: cafes,
    });
  } catch (error) {
    console.error('GET /api/cafes error:', error);
    return NextResponse.json(
      { error: 'カフェの取得に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 3. GET /api/cafes/[id] - カフェ詳細取得

**src/app/api/cafes/[id]/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCafeWithReports } from '@/lib/db/queries';

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const { id } = params;

    // UUIDバリデーション
    const uuidRegex =
      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(id)) {
      return NextResponse.json(
        { error: '有効なカフェIDを指定してください' },
        { status: 400 }
      );
    }

    // カフェ詳細取得
    const cafe = await getCafeWithReports(id);

    if (!cafe) {
      return NextResponse.json(
        { error: 'カフェが見つかりません' },
        { status: 404 }
      );
    }

    return NextResponse.json({
      success: true,
      data: cafe,
    });
  } catch (error) {
    console.error('GET /api/cafes/[id] error:', error);
    return NextResponse.json(
      { error: 'カフェ詳細の取得に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 4. POST /api/reports - 投稿作成

**src/app/api/reports/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from '@/lib/auth/getServerSession';
import { createReport } from '@/lib/db/queries';
import { createReportSchema } from '@/lib/validations/report';

export async function POST(request: NextRequest) {
  try {
    // 認証チェック
    const session = await getServerSession();
    if (!session || !session.user?.id) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      );
    }

    // リクエストボディの取得
    const body = await request.json();

    // バリデーション
    const validationResult = createReportSchema.safeParse(body);
    if (!validationResult.success) {
      return NextResponse.json(
        {
          error: 'バリデーションエラー',
          details: validationResult.error.errors,
        },
        { status: 400 }
      );
    }

    const data = validationResult.data;

    // 投稿作成
    const report = await createReport({
      cafeId: data.cafeId,
      userId: session.user.id,
      seatStatus: data.seatStatus,
      quietness: data.quietness,
      wifi: data.wifi,
      powerOutlets: data.powerOutlets,
      comment: data.comment,
    });

    return NextResponse.json(
      {
        success: true,
        data: report,
        message: '投稿が完了しました',
      },
      { status: 201 }
    );
  } catch (error) {
    console.error('POST /api/reports error:', error);
    return NextResponse.json(
      { error: '投稿に失敗しました' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const cafeId = searchParams.get('cafeId');

    if (!cafeId) {
      return NextResponse.json(
        { error: 'cafeIdパラメータが必要です' },
        { status: 400 }
      );
    }

    // カフェの投稿一覧取得
    const cafe = await getCafeWithReports(cafeId);

    if (!cafe) {
      return NextResponse.json(
        { error: 'カフェが見つかりません' },
        { status: 404 }
      );
    }

    return NextResponse.json({
      success: true,
      data: cafe.reports || [],
    });
  } catch (error) {
    console.error('GET /api/reports error:', error);
    return NextResponse.json(
      { error: '投稿の取得に失敗しました' },
      { status: 500 }
    );
  }
}
```

### 5. エラーハンドリングミドルウェア

**src/lib/api/errorHandler.ts:**
```typescript
import { NextResponse } from 'next/server';

export class ApiError extends Error {
  constructor(
    public statusCode: number,
    message: string
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

export function handleApiError(error: unknown) {
  console.error('API Error:', error);

  if (error instanceof ApiError) {
    return NextResponse.json(
      { error: error.message },
      { status: error.statusCode }
    );
  }

  return NextResponse.json(
    { error: 'サーバーエラーが発生しました' },
    { status: 500 }
  );
}
```

### 6. APIクライアント

**src/lib/api/client.ts:**
```typescript
import type { ApiResponse, CafesQueryParams } from '@/types';

export class ApiClient {
  private baseUrl = '/api';

  async getCafes(params: CafesQueryParams) {
    const query = new URLSearchParams({
      neLat: params.neLat.toString(),
      neLng: params.neLng.toString(),
      swLat: params.swLat.toString(),
      swLng: params.swLng.toString(),
    });

    if (params.filters) {
      const filters = Object.entries(params.filters)
        .filter(([_, value]) => value)
        .map(([key]) => key)
        .join(',');
      if (filters) query.append('filters', filters);
    }

    const response = await fetch(`${this.baseUrl}/cafes?${query}`);
    return this.handleResponse(response);
  }

  async getCafe(id: string) {
    const response = await fetch(`${this.baseUrl}/cafes/${id}`);
    return this.handleResponse(response);
  }

  async createReport(data: {
    cafeId: string;
    seatStatus: 'available' | 'crowded' | 'full';
    quietness: 'quiet' | 'normal' | 'noisy';
    wifi: 'fast' | 'normal' | 'slow' | 'none';
    powerOutlets: boolean;
    comment?: string;
  }) {
    const response = await fetch(`${this.baseUrl}/reports`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });
    return this.handleResponse(response);
  }

  private async handleResponse<T>(response: Response): Promise<ApiResponse<T>> {
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'APIエラー');
    }

    return data;
  }
}

export const apiClient = new ApiClient();
```

---

## 📦 成果物

### 完了チェックリスト

- [ ] src/lib/validations/report.ts が作成されている
- [ ] src/app/api/cafes/route.ts が作成されている
- [ ] src/app/api/cafes/[id]/route.ts が作成されている
- [ ] src/app/api/reports/route.ts が作成されている
- [ ] src/lib/api/errorHandler.ts が作成されている
- [ ] src/lib/api/client.ts が作成されている
- [ ] すべてのAPIが正しく動作する

### 動作確認

#### 1. カフェ一覧取得
```bash
curl "http://localhost:3000/api/cafes?neLat=35.69&neLng=139.78&swLat=35.67&swLng=139.76"
```

#### 2. カフェ詳細取得
```bash
curl "http://localhost:3000/api/cafes/{cafe-id}"
```

#### 3. 投稿作成（認証必須）
```bash
curl -X POST "http://localhost:3000/api/reports" \
  -H "Content-Type: application/json" \
  -d '{
    "cafeId": "{cafe-id}",
    "seatStatus": "available",
    "quietness": "quiet",
    "wifi": "fast",
    "powerOutlets": true,
    "comment": "窓側の席が空いてます"
  }'
```

---

## 🧪 テスト項目

| テスト項目 | 確認方法 | 期待結果 |
|-----------|---------|---------|
| カフェ一覧取得 | GET /api/cafes | 200, データ取得成功 |
| カフェ詳細取得 | GET /api/cafes/[id] | 200, 詳細取得成功 |
| 投稿作成（認証済） | POST /api/reports | 201, 投稿作成成功 |
| 投稿作成（未認証） | POST /api/reports | 401エラー |
| バリデーションエラー | POST /api/reports (不正データ) | 400エラー |
| 存在しないカフェ | GET /api/cafes/invalid-id | 404エラー |

---

## ⚠️ トラブルシューティング

### 問題1: 認証エラー

**原因**: セッションが取得できない

**解決策**:
```typescript
// Phase 4の認証設定を確認
// getServerSession()が正しく実装されているか確認
```

### 問題2: バリデーションエラー

**原因**: Zodスキーマとデータが一致しない

**解決策**:
```typescript
// createReportSchemaを確認
// リクエストボディの形式を確認
```

### 問題3: CORSエラー

**原因**: 本番環境でのCORS設定

**解決策**:
```typescript
// next.config.jsにCORS設定を追加（本番環境で必要な場合）
```

---

## 📚 参考資料

- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Zod](https://zod.dev/)
- [Drizzle ORM Queries](https://orm.drizzle.team/docs/rqb)

---

## 🎯 次のPhase

Phase 5が完了したら、**Phase 6: 地図統合** (`20251023_06-map-integration.md`) に進みます。

---

**Phase完了日**: ___________
**実績時間**: ___________
**担当者**: ___________
**レビュー**: ___________
